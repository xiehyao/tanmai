---
description: 探脉 tanmai 必做流程（修改 backend/wx-mini/frontend 后强制执行）
alwaysApply: true
---

# 探脉 tanmai 强制流程

对 `tanmai/backend/`、`tanmai/wx-mini/`、`tanmai/frontend/` 做**非临时性改动**后，必须执行：

## 1. Git 提交 + 三备份推送（强制）

- 执行 `git status` / `git diff` 自检
- 若有未跟踪或未暂存的改动，立即 `git add` 所有相关文件
- `git commit -m "模块：简短描述"`（示例：`后端：xxx 接口` / `小程序：xxx 页面` / `fix: 修复 xxx`）
- **每次 commit 后必须执行** `./scripts/git-sync.sh push`，同时推送到 本地 Gitea + 新加坡 Gitea + GitHub
- **禁止**重要代码长期只在工作区、不提交。**禁止**提交后不推送

## 2. 后端测试 + 重启（若改了 backend）

若本次修改涉及 `tanmai/backend/`，必须：

1. **运行 API 测试**：`cd tanmai/backend && python3 -m pytest tests/ -v --tb=short`（失败则修复后再提交）
2. **重启 uvicorn**：`pid=$(pgrep -f "uvicorn app.main:app.*8000" | head -1); [ -n "$pid" ] && kill $pid; sleep 2; cd tanmai/backend && nohup python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/tanmai-uvicorn.log 2>&1 &`

禁止在测试失败时提交 backend 改动。

## 3. 会话结束前自检

在完成用户任务、准备结束回复前，必须检查并完成以上步骤。**特别确认**：若有 commit，已执行 `./scripts/git-sync.sh push`。若为临时代码，需在对话中明确说明。

## 4. git-sync.sh 丢失恢复（必读）

若 `scripts/git-sync.sh` 不存在，**立即**恢复并 push：

1. 优先：`cp docs/git-sync.sh.backup scripts/git-sync.sh && chmod +x scripts/git-sync.sh && ./scripts/git-sync.sh push`
2. 若 `docs/git-sync.sh.backup` 也丢失，根据下方嵌入的脚本**新建** `scripts/git-sync.sh`，然后 `chmod +x` 并执行 push。

```bash
#!/bin/bash
# tanmai 三备份同步脚本
set -e
cd "$(dirname "$0")/.."
[ -d .git ] || { echo "Not a git repo"; exit 1; }
BRANCH="${2:-master}"
push_all() {
  git push origin "$BRANCH"
  git push sgp "$BRANCH"
  git push github "$BRANCH" 2>/dev/null || true
}
pull_smart() {
  git pull github "$BRANCH" 2>/dev/null || git pull sgp "$BRANCH"
}
case "$1" in push) push_all ;; pull) pull_smart ;; *) echo "Usage: $0 push|pull [branch]"; exit 1 ;; esac
```
