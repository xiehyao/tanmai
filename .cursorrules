# 🚨 探脉 tanmai 强制规则 - 必读 🚨

## 0. 开发环境背景

- **远程开发**：本地 Mac 通过 SSH 登录服务器（域名 www.pengyoo.com，IP 43.143.224.158），用 Cursor 做远程 AI 编程
- **服务器**：Apache、数据库均在服务器上；Cursor 终端可直接操作服务器，必要时可接管服务器终端
- **小程序调试**：Mac 用 sshfs + macfuse 挂载服务器 `/var/www/html/moodle/tanmai/`，微信官方开发者工具打开挂载后的 `wx-mini` 文件夹进行体验与截图

## 1. Git 提交 + 三备份推送（强制）

对 `tanmai/backend/`、`tanmai/wx-mini/`、`tanmai/frontend/` 做**非临时性改动**时，必须：

1. `git status` / `git diff` 自检
2. **检查 `tanmai/` 下所有相关文件是否已加入 git**；若有未跟踪或未暂存的改动，立即 `git add` 并提交
3. `git add` **所有相关文件**（如改 alumni-link 需同时 add .js / .wxml / .wxss）
4. `git commit -m "模块：简短描述"`，示例：
   - `后端：xxx 接口` / `小程序：xxx 页面`
   - `feat: 新功能` / `fix: 修复 xxx`
5. **立即执行三备份推送**：`./scripts/git-sync.sh push`（同时推送到 本地 Gitea + 新加坡 Gitea + GitHub）

**禁止**重要代码长期只在工作区、不提交。**禁止**提交后不推送。

## 2. 会话结束前自检

在完成用户任务、准备结束回复前，必须：

- 执行 `git status`，若有未提交改动，立即完成 `git add` + `git commit`
- **每次 commit 后必须执行** `./scripts/git-sync.sh push`，确保三备份（本地 Gitea + 新加坡 Gitea + GitHub）同步
- **检查后端服务**：若本次修改涉及 `tanmai/backend/`，需重启 uvicorn（`kill 旧进程` + `nohup uvicorn ...`），确保新代码生效
- 若为临时代码，需在对话中明确说明

## 3. 受保护文件

- **`.cursorrules`**：若被删除或清空，立即从 `.rules` 恢复（`cp .rules .cursorrules`）或按 `.rules` 内容重建
- **`.rules`**：`.cursorrules` 的备份；修改 `.cursorrules` 时须同步更新 `.rules`
- **`.gitignore`**：不得删除；若误删，执行 `git restore .gitignore` 恢复

## 4. 适用范围

`tanmai/` 及其子目录（backend、wx-mini、frontend 等）。上述路径内的实质性改动均需遵循本规则。
