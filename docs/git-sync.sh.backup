#!/bin/bash
# tanmai 三备份同步脚本（备份，与 scripts/git-sync.sh 保持一致）
# 用法: ./scripts/git-sync.sh push | pull [branch]
# 若 scripts/git-sync.sh 丢失：cp docs/git-sync.sh.backup scripts/git-sync.sh && chmod +x scripts/git-sync.sh

set -e
cd "$(dirname "$0")/.."
[ -d .git ] || { echo "Not a git repo"; exit 1; }
BRANCH="${2:-master}"

push_all() {
  echo ">>> Push to origin (local Gitea)..."
  git push origin "$BRANCH"
  echo ">>> Push to sgp (Singapore Gitea)..."
  git push sgp "$BRANCH"
  echo ">>> Try push to github..."
  if git push github "$BRANCH" 2>/dev/null; then
    echo "    GitHub OK"
  else
    echo "    GitHub failed (expected if blocked)"
  fi
  echo ">>> Done"
}

pull_smart() {
  echo ">>> Try pull from github..."
  if git pull github "$BRANCH" 2>/dev/null; then
    echo "    GitHub OK"
  else
    echo "    GitHub failed, pulling from sgp..."
    git pull sgp "$BRANCH"
  fi
  echo ">>> Done"
}

case "$1" in
  push) push_all ;;
  pull)  pull_smart ;;
  *)    echo "Usage: $0 push|pull [branch]"; exit 1 ;;
esac
