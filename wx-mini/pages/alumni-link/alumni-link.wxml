<!--pages/alumni-link/alumni-link.wxml-->
<view class="alumni-link-page">
  <!-- å¯¹è¯åŒºåŸŸï¼ˆå…¨å®½ï¼‰ -->
  <view class="chat-container">
    <!-- å¯¹è¯å†å²ï¼ˆåŒ…å«é—®å€™è¯­å’Œæ¶ˆæ¯ï¼‰ -->
    <scroll-view class="chat-history" scroll-y="true" scroll-top="{{scrollTop}}" scroll-with-animation="true">
      <!-- é¡¶éƒ¨é—®å€™è¯­ï¼ˆç§»åˆ°æ»šåŠ¨åŒºåŸŸå†…ï¼‰ -->
      <view class="greeting-section">
        <text class="greeting-text">Hi, {{userNickname || 'æ ¡å‹'}}</text>
      </view>

      <!-- åœºæ™¯å¡ç‰‡åŒºåŸŸï¼ˆæœªå¼€å§‹å¯¹è¯æ—¶æ˜¾ç¤ºï¼‰ -->
      <view class="mode-cards-section" wx:if="{{!hasStartedChat}}">
        <view class="mode-cards-grid">
          <view
            wx:for="{{modes}}"
            wx:key="index"
            class="mode-card {{index === activeModeIndex ? 'active' : ''}}"
            data-index="{{index}}"
            bindtap="onSelectModeCard"
          >
            <text class="mode-card-icon">{{item.icon}}</text>
            <text class="mode-card-text">{{item.label}}</text>
            <text class="mode-card-desc">{{item.desc}}</text>
          </view>
        </view>
        <!-- ç¤ºä¾‹é—®é¢˜ï¼ˆå¯ç‚¹å‡»å¡«å……ï¼‰ -->
        <view class="examples-section" wx:if="{{modes[activeModeIndex] && modes[activeModeIndex].examples}}">
          <text class="examples-title">è¯•è¯•è¿™æ ·é—®ï¼š</text>
          <view class="examples-list">
            <view
              wx:for="{{modes[activeModeIndex].examples}}"
              wx:for-item="ex"
              wx:key="*this"
              class="example-chip"
              data-text="{{ex}}"
              bindtap="onExampleTap"
            >
              <text class="example-text">{{ex}}</text>
            </view>
          </view>
        </view>
      </view>

      <view wx:if="{{messages.length === 0 && hasStartedChat}}" class="empty-message">
        <text class="empty-text">æˆ‘æ˜¯æ ¡å‹AIåŒ¹é…åŠ©æ‰‹ï¼Œå¯ä»¥æ ¹æ®ä½ çš„éœ€æ±‚åœ¨æ ¡å‹ä¸­åšæ™ºèƒ½æ¨èã€‚</text>
      </view>
      <view wx:for="{{messages}}" wx:key="index" class="msg-item {{item.role}}">
        <!-- åŠ©æ‰‹æ¶ˆæ¯ï¼šåŒºåˆ†æ€è€ƒè¿‡ç¨‹å’Œæ­£å¼ç­”æ¡ˆ -->
        <view wx:if="{{item.role === 'assistant'}}" class="assistant-msg-wrapper">
          <!-- æ€è€ƒè¿‡ç¨‹ï¼ˆæ ¡å‹åå¯ç‚¹å‡»ï¼Œä¿ç•™æ¢è¡Œï¼‰ -->
          <view wx:if="{{item.thinking}}" class="thinking-section">
            <view wx:if="{{item.thinkingSegments && item.thinkingSegments.length > 0}}" class="thinking-segments"><block wx:for="{{item.thinkingSegments}}" wx:key="idx" wx:for-item="seg"><text wx:if="{{seg.type === 'text'}}" class="thinking-text">{{seg.value}}</text><text wx:else class="alumni-name-link alumni-name-in-thinking" data-user-id="{{seg.userId}}" data-name="{{seg.name}}" bindtap="onAlumniNameTap">{{seg.name}}</text></block></view>
            <text wx:else class="thinking-text">{{item.thinking}}</text>
          </view>
          <!-- æ­£åœ¨æ€è€ƒä¸­ï¼ˆä»…åœ¨æµå¼è¾“å‡ºä¸­ï¼šæœ‰ thinking ä½†å°šæ—  answer æ—¶ï¼Œæ”¾åœ¨ä¸­é—´ï¼‰ -->
          <view wx:if="{{loading && index === messages.length - 1 && item.thinking && !item.answer}}" class="thinking-loading-indicator">
            <text class="thinking-loading-text">æ­£åœ¨æ€è€ƒä¸­...</text>
          </view>
          <!-- æ­£å¼ç­”æ¡ˆï¼ˆæ ¡å‹å§“åç”¨ view åŒ…è£¹ä»¥ä¿è¯ç‚¹å‡»æœ‰æ•ˆï¼‰ -->
          <view wx:if="{{item.answer}}" class="answer-bubble">
            <view wx:if="{{item.answerSegments && item.answerSegments.length > 0}}" class="answer-segments">
              <block wx:for="{{item.answerSegments}}" wx:key="idx" wx:for-item="seg">
                <text wx:if="{{seg.type === 'text'}}" class="answer-text">{{seg.value}}</text>
                <view wx:elif="{{seg.type === 'heading'}}" class="answer-heading"><block wx:for="{{seg.segments}}" wx:key="idx" wx:for-item="s"><text wx:if="{{s.type === 'text'}}" class="answer-heading-text">{{s.value}}</text><text wx:elif="{{s.type === 'bold'}}" class="answer-heading-bold">{{s.value}}</text><view wx:else class="alumni-name-link alumni-name-in-heading" data-user-id="{{s.userId}}" data-name="{{s.name}}" bindtap="onAlumniNameTap">{{s.name}}</view></block></view>
                <text wx:elif="{{seg.type === 'bold'}}" class="answer-bold">{{seg.value}}</text>
                <view wx:else class="alumni-name-link {{seg.bold ? 'alumni-name-bold' : ''}}" data-user-id="{{seg.userId}}" data-name="{{seg.name}}" bindtap="onAlumniNameTap">{{seg.name}}</view>
              </block>
            </view>
            <text wx:else class="answer-text">{{item.answer}}</text>
          </view>
          <!-- å¦‚æœæ²¡æœ‰åˆ†ç¦»ï¼Œæ˜¾ç¤ºåŸå§‹å†…å®¹ -->
          <view wx:if="{{!item.thinking && !item.answer && item.content}}" class="answer-bubble">
            <view wx:if="{{item.contentSegments && item.contentSegments.length > 0}}" class="answer-segments">
              <block wx:for="{{item.contentSegments}}" wx:key="idx" wx:for-item="seg">
                <text wx:if="{{seg.type === 'text'}}" class="answer-text">{{seg.value}}</text>
                <view wx:elif="{{seg.type === 'heading'}}" class="answer-heading"><block wx:for="{{seg.segments}}" wx:key="idx" wx:for-item="s"><text wx:if="{{s.type === 'text'}}" class="answer-heading-text">{{s.value}}</text><text wx:elif="{{s.type === 'bold'}}" class="answer-heading-bold">{{s.value}}</text><view wx:else class="alumni-name-link alumni-name-in-heading" data-user-id="{{s.userId}}" data-name="{{s.name}}" bindtap="onAlumniNameTap">{{s.name}}</view></block></view>
                <text wx:elif="{{seg.type === 'bold'}}" class="answer-bold">{{seg.value}}</text>
                <view wx:else class="alumni-name-link {{seg.bold ? 'alumni-name-bold' : ''}}" data-user-id="{{seg.userId}}" data-name="{{seg.name}}" bindtap="onAlumniNameTap">{{seg.name}}</view>
              </block>
            </view>
            <text wx:else class="answer-text">{{item.content}}</text>
          </view>
        </view>
        <!-- ç”¨æˆ·æ¶ˆæ¯ -->
        <view wx:else class="msg-bubble">
          <text class="msg-text">{{item.content}}</text>
        </view>
      </view>
      <!-- å¯¹è¯åå†…è”å¡ç‰‡ï¼ˆä»åŠå±é€‰æ‹©åæ’å…¥ï¼‰ -->
      <view wx:if="{{hasStartedChat && showCardsInline}}" class="mode-cards-section inline-cards">
        <view class="mode-cards-grid">
          <view
            wx:for="{{modes}}"
            wx:key="index"
            class="mode-card {{index === activeModeIndex ? 'active' : ''}}"
            data-index="{{index}}"
            bindtap="onSelectModeCard"
          >
            <text class="mode-card-icon">{{item.icon}}</text>
            <text class="mode-card-text">{{item.label}}</text>
            <text class="mode-card-desc">{{item.desc}}</text>
          </view>
        </view>
        <view class="examples-section" wx:if="{{modes[activeModeIndex] && modes[activeModeIndex].examples}}">
          <text class="examples-title">è¯•è¯•è¿™æ ·é—®ï¼š</text>
          <view class="examples-list">
            <view
              wx:for="{{modes[activeModeIndex].examples}}"
              wx:for-item="ex"
              wx:key="*this"
              class="example-chip"
              data-text="{{ex}}"
              bindtap="onExampleTap"
            >
              <text class="example-text">{{ex}}</text>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>

    <!-- å›ºå®šåé¦ˆæ ï¼ˆç½®äºè¾“å…¥åŒºä¸Šæ–¹ï¼Œå›ç­”è¶³å¤Ÿé•¿æˆ–å·²ç»“æŸæ—¶å§‹ç»ˆå¯è§ï¼‰ -->
    <view wx:if="{{lastAssistantMsg && (lastAssistantMsg.thinking || lastAssistantMsg.answer || lastAssistantMsg.content) && !lastAssistantMsg.feedback && feedbackReady}}" class="feedback-bar-fixed">
      <view class="feedback-hint-line">ç‚¹å‡»æ ¡å‹åå­—ï¼Œå¯ä»¥æŸ¥çœ‹æ ¡å‹è¯¦ç»†ä¿¡æ¯</view>
      <view class="feedback-row-top">
        <text class="feedback-label">è¿™ç¯‡å›å¤æœ‰å¸®åŠ©å—ï¼Ÿ</text>
        <text class="copy-icon" data-index="{{lastAssistantMsgIndex}}" bindtap="onCopyContent">ğŸ“‹ å¤åˆ¶å†…å®¹</text>
      </view>
      <view class="feedback-btns">
        <text class="feedback-btn" data-index="{{lastAssistantMsgIndex}}" data-value="useful" bindtap="onFeedbackTap">ğŸ‘ æœ‰ç”¨</text>
        <text class="feedback-btn" data-index="{{lastAssistantMsgIndex}}" data-value="ok" bindtap="onFeedbackTap">ğŸ˜ ä¸€èˆ¬</text>
        <text class="feedback-btn" data-index="{{lastAssistantMsgIndex}}" data-value="useless" bindtap="onFeedbackTap">ğŸ‘ æ²¡ç”¨</text>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œåŒºï¼ˆç»Ÿä¸€å·¥å…·æ  + è¾“å…¥æ¡†ï¼‰ -->
    <view class="chat-controls">
      <!-- ç»Ÿä¸€å·¥å…·æ ï¼šå†å² + æ–°è¯é¢˜ + ç­–ç•¥å¼€å…³ï¼Œå•è¡Œ -->
      <view class="unified-toolbar">
        <view class="toolbar-left">
          <view class="toolbar-icon-btn" bindtap="openHistoryDrawer">
            <text class="toolbar-icon">â˜°</text>
          </view>
          <view class="toolbar-icon-btn" bindtap="onNewTopic">
            <text class="toolbar-icon">ğŸ’¬+</text>
          </view>
        </view>
        <view class="toolbar-right">
          <view
            class="strategy-btn {{deepthinkOn ? 'active' : ''}}"
            bindtap="onToggleDeepthink"
          >
            <text class="strategy-icon">ğŸ’­</text>
            <text class="strategy-text">æ·±åº¦æ€è€ƒ</text>
          </view>
          <view
            class="strategy-btn {{knowledgeOn ? 'active' : ''}}"
            bindtap="onToggleKnowledge"
          >
            <text class="strategy-icon">ğŸ“š</text>
            <text class="strategy-text">æ ¡å‹ä¿¡æ¯åº“</text>
          </view>
        </view>
      </view>

      <!-- è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®ï¼ˆåŒ…æˆä¸€æ•´è¡Œï¼Œåœ†è§’ï¼‰ -->
      <view class="input-container">
        <view class="mode-toggle-btn" bindtap="openModeDrawer">
          <text class="mode-toggle-prefix">â‰¡</text>
          <text>{{modes[activeModeIndex] ? modes[activeModeIndex].label : 'å‘ç°'}}</text>
        </view>
        <input
          class="chat-input"
          placeholder="{{modes[activeModeIndex] ? modes[activeModeIndex].placeholder : 'æœ‰é—®é¢˜å°½ç®¡é—®ï½'}}"
          confirm-type="send"
          value="{{inputValue}}"
          bindinput="onInput"
          bindconfirm="onSend"
          adjust-position="true"
        />
        <view
          class="send-btn {{inputValue.trim() ? 'active' : ''}}"
          bindtap="onSend"
        >
          <text class="send-icon">â–²</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å†å²æŠ½å±‰ -->
  <view class="history-drawer-mask" wx:if="{{showHistoryDrawer}}" bindtap="closeHistoryDrawer"></view>
  <view class="history-drawer {{showHistoryDrawer ? 'show' : ''}}" catchtap="stopPropagation">
    <view class="drawer-header">
      <text class="drawer-title">å†å²ä¸»é¢˜</text>
      <text class="drawer-close" bindtap="closeHistoryDrawer">âœ•</text>
    </view>
    <scroll-view class="drawer-content" scroll-y="true">
      <view wx:if="{{topics.length === 0}}" class="empty-topics">
        <text>æš‚æ— å†å²ä¸»é¢˜</text>
      </view>
      <view
        wx:for="{{topics}}"
        wx:key="id"
        class="topic-item {{currentTopicId === item.id ? 'active' : ''}}"
        data-topic-id="{{item.id}}"
        bindtap="selectTopic"
      >
        <view class="topic-header">
          <text class="topic-mode">{{item.mode}}</text>
          <text class="topic-time">{{item.createTime}}</text>
        </view>
        <text class="topic-title">{{item.title}}</text>
        <text class="topic-preview" wx:if="{{item.messages && item.messages.length > 0}}">
          {{item.messages[0].content}}
        </text>
      </view>
    </scroll-view>
  </view>

  <!-- åŠå±æ¨¡å¼é€‰æ‹©æŠ½å±‰ï¼ˆâ‰¡ æŒ‰é’®æ‰“å¼€ï¼‰ -->
  <view class="mode-drawer-mask" wx:if="{{showModeDrawer}}" bindtap="closeModeDrawer"></view>
  <view class="mode-drawer {{showModeDrawer ? 'show' : ''}}" catchtap="stopPropagation">
    <view class="mode-drawer-header">
      <text class="mode-drawer-title">é€‰æ‹©åœºæ™¯</text>
      <text class="mode-drawer-close" bindtap="closeModeDrawer">âœ•</text>
    </view>
    <scroll-view class="mode-drawer-content" scroll-y="true">
      <view class="mode-drawer-inner">
      <view class="greeting-section">
        <text class="greeting-text">Hi, {{userNickname || 'æ ¡å‹'}}</text>
      </view>
      <view class="mode-cards-grid">
        <view
          wx:for="{{modes}}"
          wx:key="index"
          class="mode-card {{index === activeModeIndex ? 'active' : ''}}"
          data-index="{{index}}"
          bindtap="onSelectModeFromDrawer"
        >
          <text class="mode-card-icon">{{item.icon}}</text>
          <text class="mode-card-text">{{item.label}}</text>
          <text class="mode-card-desc">{{item.desc}}</text>
        </view>
      </view>
      <view class="examples-section" wx:if="{{modes[activeModeIndex] && modes[activeModeIndex].examples}}">
        <text class="examples-title">è¯•è¯•è¿™æ ·é—®ï¼š</text>
        <view class="examples-list">
          <view
            wx:for="{{modes[activeModeIndex].examples}}"
            wx:for-item="ex"
            wx:key="*this"
            class="example-chip"
            data-text="{{ex}}"
            bindtap="onExampleTapFromDrawer"
          >
            <text class="example-text">{{ex}}</text>
          </view>
        </view>
      </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ ¡å‹åç‰‡åŠå±æµ®å±‚ï¼ˆç‚¹å‡»ç­”æ¡ˆä¸­çš„æ ¡å‹å§“åå¼¹å‡ºï¼‰ -->
  <view class="alumni-card-mask" wx:if="{{showAlumniCard}}" bindtap="closeAlumniCard"></view>
  <view class="alumni-card-modal {{showAlumniCard ? 'show' : ''}}" catchtap="stopPropagation">
    <text class="alumni-card-close" catchtap="closeAlumniCard">Ã—</text>
    <view class="alumni-card-body">
      <view class="alumni-card-main">
        <image
          class="alumni-card-avatar"
          src="{{alumniCardData.display_avatar || alumniCardData.avatar || alumniCardData.selected_avatar || 'https://tanmai-1318644773.cos.ap-guangzhou.myqcloud.com/avatars/male-young-1.png'}}"
          mode="aspectFill"
        />
        <view class="alumni-card-info">
          <text class="alumni-card-name">{{alumniCardData.name || alumniCardData.nickname || 'æ ¡å‹'}}</text>
          <text class="alumni-card-nickname" wx:if="{{alumniCardData.nickname && alumniCardData.name && alumniCardData.name !== alumniCardData.nickname}}">({{alumniCardData.nickname}})</text>
          <text class="alumni-card-line" wx:if="{{alumniCardData.wechat_id}}">å¾®ä¿¡ID: {{alumniCardData.wechat_id}}</text>
          <text class="alumni-card-line">{{(alumniCardData.company || '') + (alumniCardData.company && alumniCardData.title ? ' ' : '') + (alumniCardData.title || '')}}</text>
        </view>
      </view>
      <view class="alumni-card-extra">
        <text class="alumni-card-line" wx:if="{{alumniCardData.phone}}">{{alumniCardData.phone}}</text>
        <text class="alumni-card-line" wx:if="{{alumniCardData.email}}">{{alumniCardData.email}}</text>
        <text class="alumni-card-line address" wx:if="{{alumniCardData.address}}">{{alumniCardData.address}}</text>
      </view>
      <view class="alumni-card-detail-btn-wrap">
        <button class="alumni-card-detail-btn" bindtap="goToAlumniProfileFromCard">æŸ¥çœ‹è¯¦æƒ…</button>
      </view>
    </view>
    <view class="alumni-card-bio" wx:if="{{alumniCardData.bio}}">
      <text class="alumni-card-bio-text">{{alumniCardData.bio}}</text>
    </view>
  </view>
</view>
