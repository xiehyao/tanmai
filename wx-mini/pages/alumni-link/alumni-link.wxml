<!--pages/alumni-link/alumni-link.wxml-->
<view class="alumni-link-page">
  <!-- é¡¶éƒ¨æ ï¼ˆæ–¹æ¡ˆBï¼šæ ‡é¢˜ç”±ç³»ç»Ÿå¯¼èˆªæ æ˜¾ç¤ºï¼Œæ­¤å¤„ä»…ä¿ç•™èœå•ä¸æ–°å»ºï¼‰ -->
  <view class="header-bar">
    <view class="header-left" bindtap="openHistoryDrawer">
      <text class="menu-icon">â˜°</text>
    </view>
    <view class="header-right" bindtap="onNewTopic">
      <text class="new-topic-icon">ğŸ’¬+</text>
    </view>
  </view>

  <!-- å¯¹è¯åŒºåŸŸï¼ˆå…¨å®½ï¼‰ -->
  <view class="chat-container">
    <!-- å¯¹è¯å†å²ï¼ˆåŒ…å«é—®å€™è¯­å’Œæ¶ˆæ¯ï¼‰ -->
    <scroll-view class="chat-history" scroll-y="true" scroll-top="{{scrollTop}}" scroll-with-animation="true">
      <!-- é¡¶éƒ¨é—®å€™è¯­ï¼ˆç§»åˆ°æ»šåŠ¨åŒºåŸŸå†…ï¼‰ -->
      <view class="greeting-section">
        <text class="greeting-text">Hi, {{userNickname || 'æ ¡å‹'}}</text>
      </view>

      <!-- åœºæ™¯å¡ç‰‡åŒºåŸŸï¼ˆæœªå¼€å§‹å¯¹è¯æ—¶æ˜¾ç¤ºï¼‰ -->
      <view class="mode-cards-section" wx:if="{{!hasStartedChat}}">
        <view class="mode-cards-grid">
          <view
            wx:for="{{modes}}"
            wx:key="index"
            class="mode-card {{index === activeModeIndex ? 'active' : ''}}"
            data-index="{{index}}"
            bindtap="onSelectModeCard"
          >
            <text class="mode-card-icon">{{item.icon}}</text>
            <text class="mode-card-text">{{item.label}}</text>
            <text class="mode-card-desc">{{item.desc}}</text>
          </view>
        </view>
        <!-- ç¤ºä¾‹é—®é¢˜ï¼ˆå¯ç‚¹å‡»å¡«å……ï¼‰ -->
        <view class="examples-section" wx:if="{{modes[activeModeIndex] && modes[activeModeIndex].examples}}">
          <text class="examples-title">è¯•è¯•è¿™æ ·é—®ï¼š</text>
          <view class="examples-list">
            <view
              wx:for="{{modes[activeModeIndex].examples}}"
              wx:for-item="ex"
              wx:key="*this"
              class="example-chip"
              data-text="{{ex}}"
              bindtap="onExampleTap"
            >
              <text class="example-text">{{ex}}</text>
            </view>
          </view>
        </view>
      </view>

      <view wx:if="{{messages.length === 0 && hasStartedChat}}" class="empty-message">
        <text class="empty-text">æˆ‘æ˜¯æ ¡å‹AIåŒ¹é…åŠ©æ‰‹ï¼Œå¯ä»¥æ ¹æ®ä½ çš„éœ€æ±‚åœ¨æ ¡å‹ä¸­åšæ™ºèƒ½æ¨èã€‚</text>
      </view>
      <view wx:for="{{messages}}" wx:key="index" class="msg-item {{item.role}}">
        <!-- åŠ©æ‰‹æ¶ˆæ¯ï¼šåŒºåˆ†æ€è€ƒè¿‡ç¨‹å’Œæ­£å¼ç­”æ¡ˆ -->
        <view wx:if="{{item.role === 'assistant'}}" class="assistant-msg-wrapper">
          <!-- æ€è€ƒè¿‡ç¨‹ -->
          <view wx:if="{{item.thinking}}" class="thinking-section">
            <text class="thinking-text">{{item.thinking}}</text>
          </view>
          <!-- æ­£å¼ç­”æ¡ˆ -->
          <view wx:if="{{item.answer}}" class="answer-bubble">
            <text class="answer-text">{{item.answer}}</text>
          </view>
          <!-- å¦‚æœæ²¡æœ‰åˆ†ç¦»ï¼Œæ˜¾ç¤ºåŸå§‹å†…å®¹ -->
          <view wx:if="{{!item.thinking && !item.answer && item.content}}" class="answer-bubble">
            <text class="answer-text">{{item.content}}</text>
          </view>
          <!-- åé¦ˆå…¥å£ï¼ˆä»…å½“æœ‰å†…å®¹ä¸”æœªåé¦ˆæ—¶æ˜¾ç¤ºï¼‰ -->
          <view wx:if="{{item.content && !item.feedback}}" class="feedback-row">
            <text class="feedback-label">è¿™ç¯‡å›å¤æœ‰å¸®åŠ©å—ï¼Ÿ</text>
            <view class="feedback-btns">
              <text class="feedback-btn" data-index="{{index}}" data-value="useful" bindtap="onFeedbackTap">ğŸ‘ æœ‰ç”¨</text>
              <text class="feedback-btn" data-index="{{index}}" data-value="ok" bindtap="onFeedbackTap">ğŸ˜ ä¸€èˆ¬</text>
              <text class="feedback-btn" data-index="{{index}}" data-value="useless" bindtap="onFeedbackTap">ğŸ‘ æ²¡ç”¨</text>
            </view>
          </view>
        </view>
        <!-- ç”¨æˆ·æ¶ˆæ¯ -->
        <view wx:else class="msg-bubble">
          <text class="msg-text">{{item.content}}</text>
        </view>
      </view>
      <view wx:if="{{loading}}" class="msg-item assistant">
        <view class="assistant-msg-wrapper">
          <view class="thinking-section">
            <text class="thinking-text">æ­£åœ¨æ€è€ƒä¸­...</text>
          </view>
        </view>
      </view>
    </scroll-view>

    <!-- åº•éƒ¨æ“ä½œåŒº -->
    <view class="chat-controls">
      <!-- æ¨¡å¼é€‰æ‹©æ»šåŠ¨æ¡† + ç­–ç•¥æŒ‰é’® -->
      <view class="controls-row">
        <!-- æ¨¡å¼é€‰æ‹©æ»šåŠ¨æ¡† -->
        <scroll-view class="mode-selector" scroll-x="true" wx:if="{{showModeSelector}}">
          <view class="mode-selector-content">
        <view
          wx:for="{{modes}}"
          wx:key="index"
          class="mode-selector-item {{index === activeModeIndex ? 'active' : ''}}"
          data-index="{{index}}"
          bindtap="onSelectModeFromSelector"
        >
          <text>{{item.label}}</text>
        </view>
          </view>
        </scroll-view>

        <!-- ç­–ç•¥æŒ‰é’®ï¼ˆå«ç®€çŸ­è¯´æ˜ï¼‰ -->
        <view class="strategy-row">
          <view class="strategy-buttons">
            <view
              class="strategy-btn {{strategy === 'deepthink' ? 'active' : ''}}"
              data-strategy="deepthink"
              bindtap="onSelectStrategy"
            >
              <text class="strategy-icon">ğŸ’­</text>
              <text class="strategy-text">æ·±åº¦æ€è€ƒ</text>
            </view>
            <view
              class="strategy-btn {{strategy === 'knowledge' ? 'active' : ''}}"
              data-strategy="knowledge"
              bindtap="onSelectStrategy"
            >
              <text class="strategy-icon">ğŸ“š</text>
              <text class="strategy-text">æ ¡å‹çŸ¥è¯†åº“</text>
            </view>
          </view>
          <text class="strategy-hint">{{strategy === 'deepthink' ? 'é€‚åˆå¤æ‚éœ€æ±‚ï¼ŒAIä¼šå¤šæ­¥æ¨ç†' : 'é€‚åˆå¿«é€ŸæŸ¥äººã€æŸ¥æ´»åŠ¨'}}</text>
        </view>
      </view>

      <!-- è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®ï¼ˆåŒ…æˆä¸€æ•´è¡Œï¼Œåœ†è§’ï¼‰ -->
      <view class="input-container">
        <view class="mode-toggle-btn" bindtap="toggleModeSelector" wx:if="{{!showModeSelector}}">
          <text>{{modes[activeModeIndex] ? modes[activeModeIndex].label : 'å‘ç°'}}</text>
        </view>
        <input
          class="chat-input"
          placeholder="{{modes[activeModeIndex] ? modes[activeModeIndex].placeholder : 'æœ‰é—®é¢˜å°½ç®¡é—®ï½'}}"
          confirm-type="send"
          value="{{inputValue}}"
          bindinput="onInput"
          bindconfirm="onSend"
          adjust-position="true"
        />
        <view
          class="send-btn {{inputValue.trim() ? 'active' : ''}}"
          bindtap="onSend"
        >
          <text class="send-icon">â–²</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å†å²æŠ½å±‰ -->
  <view class="history-drawer-mask" wx:if="{{showHistoryDrawer}}" bindtap="closeHistoryDrawer"></view>
  <view class="history-drawer {{showHistoryDrawer ? 'show' : ''}}" catchtap="stopPropagation">
    <view class="drawer-header">
      <text class="drawer-title">å†å²ä¸»é¢˜</text>
      <text class="drawer-close" bindtap="closeHistoryDrawer">âœ•</text>
    </view>
    <scroll-view class="drawer-content" scroll-y="true">
      <view wx:if="{{topics.length === 0}}" class="empty-topics">
        <text>æš‚æ— å†å²ä¸»é¢˜</text>
      </view>
      <view
        wx:for="{{topics}}"
        wx:key="id"
        class="topic-item {{currentTopicId === item.id ? 'active' : ''}}"
        data-topic-id="{{item.id}}"
        bindtap="selectTopic"
      >
        <view class="topic-header">
          <text class="topic-mode">{{item.mode}}</text>
          <text class="topic-time">{{item.createTime}}</text>
        </view>
        <text class="topic-title">{{item.title}}</text>
        <text class="topic-preview" wx:if="{{item.messages && item.messages.length > 0}}">
          {{item.messages[0].content}}
        </text>
      </view>
    </scroll-view>
  </view>
</view>
